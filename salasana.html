<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lahen kaunpunginosat mysteeri</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Muutettu starttiin, jotta yläpuolelle jää tilaa */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;

            /* Maastomainen tausta */
            background-color: #3e4a36; /* Tummanvihreä pohja */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" height=\"100%\" viewBox=\"0 0 800 800\"><defs><filter id=\"f\" x=\"0\" y=\"0\"><feTurbulence type=\"fractalNoise\" baseFrequency=\"0.7\" numOctaves=\"4\" stitchTiles=\"stitch\" result=\"noise\" /><feGaussianBlur in=\"noise\" stdDeviation=\"15\" /><feColorMatrix type=\"saturate\" values=\"0.7\" /><feBlend in=\"SourceGraphic\" in2=\"noise\" mode=\"multiply\" /></filter></defs><rect width=\"100%\" height=\"100%\" fill=\"#3e4a36\" /><rect width=\"100%\" height=\"100%\" filter=\"url(#f)\" opacity=\"0.5\" /><circle cx=\"400\" cy=\"400\" r=\"300\" fill=\"none\" stroke=\"rgba(255,255,255,0.1)\" stroke-width=\"1\" /><circle cx=\"400\" cy=\"400\" r=\"200\" fill=\"none\" stroke=\"rgba(255,255,255,0.05)\" stroke-width=\"1\" /></svg>');
            background-size: cover;
            background-attachment: fixed; /* Taustakuva pysyy paikallaan skrollatessa */
            color: #d1d1d1; /* Vaalea teksti */
            line-height: 1.6;
        }

        #logoContainer {
            margin-bottom: 20px;
        }

        #logoContainer img {
            width: 150px; /* Säädä logon kokoa tarpeen mukaan */
            height: auto;
            border-radius: 8px; /* Pyöristetyt kulmat logolle */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Varjo logolle */
        }

        .container {
            background-color: rgba(30, 40, 25, 0.9); /* Tummempi, hieman läpinäkyvä tausta lomakkeelle */
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5); /* Vahvempi varjo */
            text-align: center;
            width: 100%;
            max-width: 500px;
            margin-top: 20px; /* Tilaa logon ja laatikon väliin */
            border: 1px solid rgba(70, 80, 60, 0.5); /* Hieno reunus */
            backdrop-filter: blur(5px); /* Kevyt sumennus taustalle (moderni ominaisuus) */
        }

        h1 { /* Huom: Tämä h1 ei ollut alkuperäisessä HTML:ssäsi, mutta pidin sen CSS:ssä, jos haluat lisätä sen myöhemmin */
            color: #a4c973; /* Maastonvihreän sävy */
            margin-bottom: 25px;
            font-size: 2.2em;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }

        #promptKuva {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            border: 2px solid #5a7a42; /* Viitteellinen kehys kuvalle */
        }

        #kuvaTekstiLabel {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #5a7a42;
            border-radius: 6px;
            background-color: #2a3520;
            color: #d1d1d1;
            font-size: 1em;
            outline: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #a4c973;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 8px rgba(164, 201, 115, 0.4);
        }

        button {
            background-color: #6b9a4c; /* Nappi tummempi vihreä */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            background-color: #82b260; /* Hiukan vaaleampi hoverilla */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background-color: #4a5d3a;
            cursor: not-allowed;
            box-shadow: none;
        }

        .message {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .message.success {
            color: #a4c973; /* Onnistumisviestin väri */
            text-shadow: 0 0 5px rgba(164, 201, 115, 0.7);
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSBHRFCKEP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-LSBHRFCKEP'); 
    </script>
</head>
<body>

    <div id="logoContainer">
        <img src="logo.png" alt="Mikko Kalevi Logo">
    </div>

    <div class="container">
        <label for="salasanaInput" id="kysymysLabel">Ladataan arvoitusta...</label>
        <div id="kuvaContainer" style="display: none;">
            <img id="promptKuva" src="" alt="Vihje">
        </div>
        <p id="kuvaTekstiLabel" style="display: none; margin-top: 10px; font-size: 1em; color: #dbe0d7; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);"></p>
        <br>
        <input type="text" id="salasanaInput" autofocus disabled><br>
        <button onclick="tarkistaSalasana()" disabled>Tarkista</button>
        <p id="viesti"></p>
    </div>

    <script src="puzzle_data.js"></script>

    <script>
        // Elementtien viittaukset on nyt mukautettu vastaamaan HTML-tiedostosi ID-nimiä
        const inputField = document.getElementById('salasanaInput');
        // Koska napilla ei ollut ID:tä, käytetään suoraan "button" elementtiä tai poistetaan käytöstä
        // Jos haluat napille suoran viittauksen, lisää sille id="submitButton" HTML-koodiin
        // Esim. <button id="submitButton" onclick="tarkistaSalasana()" disabled>Tarkista</button>
        const submitButton = document.querySelector('button'); // Etsii ensimmäisen button-elementin
        const viestiElementti = document.getElementById('viesti');
        const kuvaContainer = document.getElementById('kuvaContainer');
        const promptKuva = document.getElementById('promptKuva');
        const kuvaTekstiLabel = document.getElementById('kuvaTekstiLabel');
        const kysymysLabel = document.getElementById('kysymysLabel');


        let currentStepIndex = 0;

        // updateChallengeDisplay päivitetty käyttämään oikeita elementtejä
        function updateChallengeDisplay(imageFileName, textContent) {
            if (imageFileName) {
                promptKuva.src = imageFileName;
                kuvaContainer.style.display = 'block';
            } else {
                kuvaContainer.style.display = 'none';
            }
            if (textContent) {
                kuvaTekstiLabel.textContent = textContent;
                kuvaTekstiLabel.style.display = 'block';
                kysymysLabel.style.display = 'none'; // Piilota kysymysLabel jos kuvaTekstiLabel on
            } else {
                kuvaTekstiLabel.style.display = 'none';
                kysymysLabel.style.display = 'block'; // Näytä kysymysLabel jos kuvaTekstiLabel ei ole
            }
        }

        function initializePuzzle() {
            currentStepIndex = 0;
            const firstStepData = puzzleSetup.steps[currentStepIndex];
            // Ensimmäisessä vaiheessa challengeImage ja challengeText ovat null
            // updateChallengeDisplay hoitaa oikean näytön (kuvaContainer piilossa, kysymysLabel näkyvissä)
            updateChallengeDisplay(firstStepData.challengeImage, firstStepData.challengeText || puzzleSetup.initialPrompt);
            
            inputField.value = "";
            viestiElementti.textContent = "";
            viestiElementti.className = ''; // Palauttaa oletusluokan
            inputField.disabled = false;
            submitButton.disabled = false;
            inputField.focus();

            // Varmistetaan, että ensimmäisen vaiheen kohdalla kysymysLabel on näkyvissä
            if (!firstStepData.challengeImage && !firstStepData.challengeText) {
                kysymysLabel.textContent = puzzleSetup.initialPrompt;
                kysymysLabel.style.display = 'block';
                kuvaTekstiLabel.style.display = 'none';
                kuvaContainer.style.display = 'none';
            }
        }

        function tarkistaSalasana() {
            const userAnswer = inputField.value.trim();
            const currentStep = puzzleSetup.steps[currentStepIndex];

            let expectedAnswer;
            if (typeof currentStep.expectedInput === 'function') {
                expectedAnswer = currentStep.expectedInput();
            } else {
                expectedAnswer = currentStep.expectedInput;
            }

            if (userAnswer === expectedAnswer) {
                viestiElementti.textContent = currentStep.responseMessage;
                viestiElementti.className = 'message success';
                
                // Nollataan virheyritykset onnistuneen vastauksen jälkeen
                currentStep.wrongAttemptsMade = 0;

                if (currentStepIndex === puzzleSetup.steps.length - 1) {
                    // PELIN LOPPU - ONNISTUNUT SUORITUS
                    // Tässä tapauksessa challengeText ja challengeImage saattavat olla itse loppuviesti
                    // Varmista, että ne ovat oikein määritelty puzzle_data.js tiedostossa
                    updateChallengeDisplay(currentStep.challengeImage, currentStep.responseMessage); // Tässä näytetään loppuviesti

                    viestiElementti.className = 'message success'; 
                    inputField.disabled = true;
                    submitButton.disabled = true;

                    // --- LISÄTTY GOOGLE ANALYTICS -KOODI (ONNISTUNUT LOPETUS) ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'puzzle_completed', {
                            'event_category': 'Puzzle',
                            'event_label': 'Pelattu loppuun',
                            'puzzle_name': 'Lahen kaupunginosat mysteeri', // Päivitetty nimi
                            'final_step_number': currentStepIndex + 1
                        });
                    }
                    // ----------------------------------------------------------

                } else {
                    // VAIHE ONNISTUNEESTI RATKAISTU - SIIRRY SEURAAVAAN
                    currentStepIndex++;
                    const nextChallengeData = puzzleSetup.steps[currentStepIndex];
                    updateChallengeDisplay(nextChallengeData.challengeImage, nextChallengeData.challengeText || nextChallengeData.responseMessage);
                    inputField.value = "";
                    inputField.focus();

                    // --- LISÄTTY GOOGLE ANALYTICS -KOODI (VAIHE RATKAISTU) ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'puzzle_step_completed', {
                            'event_category': 'Puzzle',
                            'event_label': 'Vaihe ratkaistu',
                            'puzzle_name': 'Lahen kaupunginosat mysteeri', // Päivitetty nimi
                            'step_number': currentStepIndex, // currentStepIndex on jo seuraavaan vaiheeseen siirretty
                            'challenge_text': nextChallengeData.challengeText || 'Salasana'
                        });
                    }
                    // ----------------------------------------------------------
                }
            } else {
                // Väärä syöte
                // Varmista, että puzzle_data.js:ssä on wrongAttemptsMade ja maxWrongAttempts jokaisessa vaiheessa
                currentStep.wrongAttemptsMade = (currentStep.wrongAttemptsMade || 0) + 1; 

                if (currentStep.maxWrongAttempts > 0 && currentStep.wrongAttemptsMade <= currentStep.maxWrongAttempts) {
                    viestiElementti.textContent = puzzleSetup.wrongInputMessage + 
                                                  ` (${currentStep.wrongAttemptsMade}/${currentStep.maxWrongAttempts} väärää yritystä)`;
                    viestiElementti.className = ''; 
                    inputField.value = "";
                    inputField.focus();

                    // --- LISÄTTY GOOGLE ANALYTICS -KOODI (VÄÄRÄ VASTAUS, MUTTA YRITYKSIÄ JÄLJELLÄ) ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'puzzle_wrong_answer', {
                            'event_category': 'Puzzle',
                            'event_label': 'Väärä vastaus',
                            'puzzle_name': 'Lahen kaupunginosat mysteeri', // Päivitetty nimi
                            'step_number': currentStepIndex + 1,
                            'attempts_left': currentStep.maxWrongAttempts - currentStep.wrongAttemptsMade
                        });
                    }
                    // ----------------------------------------------------------------------

                } else {
                    // Väärin meni liian monta kertaa! Palataan alkuun.
                    viestiElementti.textContent = puzzleSetup.finalFailMessage;
                    viestiElementti.className = '';
                    
                    // --- LISÄTTY GOOGLE ANALYTICS -KOODI (PELI Nollaantuu liian monen virheen vuoksi) ---
                    if (typeof gtag === 'function') {
                        gtag('event', 'puzzle_reset_on_fail', {
                            'event_category': 'Puzzle',
                            'event_label': 'Peli nollautui virheiden vuoksi',
                            'puzzle_name': 'Lahen kaupunginosat mysteeri', // Päivitetty nimi
                            'step_number_at_reset': currentStepIndex + 1
                        });
                    }
                    // -------------------------------------------------------------------------

                    initializePuzzle(); // Tämä johtaa siihen, että peli alkaa alusta.
                    inputField.value = "";
                    inputField.focus();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializePuzzle();
            inputField.addEventListener('keypress', function(event) {
                // Tarkistus, ettei nappi ole disabled.
                // Koska buttonissa on onclick="tarkistaSalasana()", emme voi suoraan tarkistaa .disabled ominaisuutta tässä,
                // ellei buttonille anneta ID:tä ja viitata siihen JavaScriptissä.
                // Oletetaan, että inputField.disabled vastaa submitButton.disabled tilaa.
                if (event.key === 'Enter' && !inputField.disabled) { 
                    tarkistaSalasana();
                }
            });
            // Tässä buttonin onclick jo hoitaa klikkauksen, joten erillistä addEventListeneriä ei tarvita,
            // ellei napille lisätä ID:tä ja haluta erillistä JS-kuuntelijaa.
            // submitButton.addEventListener('click', tarkistaSalasana); // Pois kommentoitu, jos käytät onclick="tarkistaSalasana()"
        });
    </script>

</body>
</html>
