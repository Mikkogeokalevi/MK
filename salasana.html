<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salasanakysely Mysteeri</title>
    </head>
<body>
    <img id="headerLogo" src="logo.png" alt="Logo" style="max-width: 150px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">

    <p id="challengeText" style="text-align: center; font-size: 1.2em; margin-bottom: 20px;"></p>
    
    <div style="text-align: center;">
        <img id="challengeImage" src="" alt="Haastekuva" style="display:none; max-width: 100%; height: auto; margin-bottom: 20px;">
        <br>
        <input type="text" id="passwordInput" placeholder="Syötä vastaus" style="padding: 8px; font-size: 1em; width: 80%; max-width: 300px;">
        <button id="submitButton" style="padding: 8px 15px; font-size: 1em; cursor: pointer;">Tarkista</button>
        <p id="message" style="color: red; margin-top: 10px;"></p>
        <p id="attemptsLeft" style="font-size: 0.9em; color: grey; display: none;"></p>
    </div>

    <script src="puzzle_data.js"></script>
    <script>
        const inputField = document.getElementById('passwordInput');
        const submitButton = document.getElementById('submitButton');
        const messageElement = document.getElementById('message');
        const challengeImageElement = document.getElementById('challengeImage');
        const challengeTextElement = document.getElementById('challengeText'); // Tämä näyttää nyt myös initialPromptin
        const attemptsLeftElement = document.getElementById('attemptsLeft');

        let currentStepIndex = 0;

        function updateChallengeDisplay(imageFileName, textContent) {
            if (imageFileName) {
                challengeImageElement.src = imageFileName;
                challengeImageElement.style.display = 'block';
            } else {
                challengeImageElement.style.display = 'none';
                challengeImageElement.src = ''; // Tyhjennä src varmuuden vuoksi
            }
            challengeTextElement.textContent = textContent; // Asettaa tekstin
        }

        function initializePuzzle() {
            currentStepIndex = 0;
            // Ensimmäisessä vaiheessa näytetään initialPrompt
            updateChallengeDisplay(null, puzzleSetup.initialPrompt); // Ei kuvaa, vain teksti
            inputField.value = "";
            messageElement.textContent = "";
            messageElement.style.color = 'red'; // Asetetaan oletusväri virheviesteille
            inputField.disabled = false;
            submitButton.disabled = false;
            attemptsLeftElement.style.display = 'none';
            resetAttempts();
            inputField.focus(); // Aseta kohdistus heti input-kenttään
        }

        function resetAttempts() {
            puzzleSetup.steps.forEach(step => {
                step.wrongAttemptsMade = 0;
            });
        }

        function tarkistaSalasana() {
            const userAnswer = inputField.value.trim();
            const currentStepData = puzzleSetup.steps[currentStepIndex];

            let expectedAnswer;
            if (typeof currentStepData.expectedInput === 'function') {
                expectedAnswer = currentStepData.expectedInput();
            } else {
                expectedAnswer = currentStepData.expectedInput;
            }

            if (userAnswer === expectedAnswer) {
                messageElement.textContent = currentStepData.responseMessage;
                messageElement.style.color = 'green'; // Vihreä väri onnistumisviestille
                
                if (currentStepIndex === puzzleSetup.steps.length - 1) {
                    inputField.disabled = true;
                    submitButton.disabled = true;
                    attemptsLeftElement.style.display = 'none';
                } else {
                    currentStepIndex++;
                    const nextChallengeData = puzzleSetup.steps[currentStepIndex];
                    updateChallengeDisplay(nextChallengeData.challengeImage, nextChallengeData.challengeText);
                    inputField.value = "";
                    inputField.focus();
                    attemptsLeftElement.style.display = 'none';
                }
            } else {
                currentStepData.wrongAttemptsMade++;
                const attemptsRemaining = currentStepData.maxWrongAttempts - currentStepData.wrongAttemptsMade;

                if (attemptsRemaining > 0) {
                    messageElement.textContent = puzzleSetup.wrongInputMessage;
                    messageElement.style.color = 'red'; // Punainen väri virheviestille
                    attemptsLeftElement.textContent = `Vääriä yrityksiä jäljellä: ${attemptsRemaining}`;
                    attemptsLeftElement.style.display = 'block';
                    inputField.value = "";
                    inputField.focus();
                } else {
                    messageElement.textContent = puzzleSetup.finalFailMessage;
                    messageElement.style.color = 'red'; // Punainen väri viimeiselle virheviestille
                    inputField.disabled = true;
                    submitButton.disabled = true;
                    attemptsLeftElement.style.display = 'none';
                    setTimeout(initializePuzzle, 3000); // Palataan alkuun 3 sekunnin viiveellä
                }
            }
        }

        // TÄRKEÄ MUUTOS: initializePuzzle kutsutaan vasta, kun koko sivu on ladattu
        window.onload = function() {
            initializePuzzle();
        };

        document.addEventListener('DOMContentLoaded', () => {
            inputField.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !submitButton.disabled) {
                    tarkistaSalasana();
                }
            });

            submitButton.addEventListener('click', tarkistaSalasana);
        });
    </script>

</body>
</html>
